<?xml version="1.0" encoding="utf-8"?>
<odoo>
  <data>
    <template id="modern_report_saleorder_document" name="Modern Sale Order RTL">
      <!-- متغير الشركة -->
      <t t-set="company" t-value="(doc and doc.company_id) or res_company"/>

      <!-- ✅ صفحة الغلاف مستقلة (بدون external_layout) -->
      <t t-call="company_sale_report_cover.cover_page"/>

      <!-- ✅ من هنا يبدأ التقرير العادي داخل الـ external_layout -->
      <t t-call="web.external_layout">
        <t t-set="doc" t-value="doc.with_context({'lang': doc.partner_id.lang})"/>

        <div class="page" style="direction: rtl; text-align: right; font-family: 'Tahoma','Arial',sans-serif;">
          <div class="oe_structure"/>

          <!-- جدول بيانات عامة -->
          <table class="table table-sm table-borderless" style="table-layout:fixed; direction: rtl; text-align: right;">
            <thead>
              <tr>
                <th width="20%" t-attf-style="background-color: #{company.color_sale or 'transparent'}; color: #{company.text_color_sale or '#000'}; text-align: center;">
                  العميل
                </th>
                <th width="20%" t-attf-style="background-color: #{company.color_sale or 'transparent'}; color: #{company.text_color_sale or '#000'}; text-align: center;">
                  تاريخ العرض
                </th>
                <th width="20%" t-attf-style="background-color: #{company.color_sale or 'transparent'}; color: #{company.text_color_sale or '#000'}; text-align: center;">
                  رقم العرض
                </th>
                <th width="40%" t-attf-style="background-color: #{company.color_sale or 'transparent'}; color: #{company.text_color_sale or '#000'}; text-align: center;">
                  نوع المنتجات والخدمات
                </th>
              </tr>
            </thead>
            <tbody class="sale_tbody">
              <tr>
                <td><strong><span t-field="doc.partner_id"/></strong></td>
                <td class="text-center"><strong><span t-field="doc.date_order" t-options="{'widget': 'date'}"/></strong></td>
                <td class="text-center"><strong><span t-field="doc.name"/></strong></td>
                <td class="text-center"><strong><span t-field="doc.service_type_id"/></strong></td>
              </tr>
            </tbody>
          </table>

          <!-- هل يوجد خصم -->
          <t t-set="display_discount" t-value="any([l.discount for l in doc.order_line])"/>

          <!-- جدول البنود -->
          <table class="table table-sm table-borderless" style="direction: rtl; text-align: right;">
            <thead>
              <tr>
                <th>الوصف</th>
                <th class="text-center">الكمية</th>
                <th class="text-center">السعر</th>
                <th t-if="display_discount" class="text-center" groups="sale.group_discount_per_so_line">الخصم</th>
                <th class="text-center">الضريبة</th>
                <th class="text-center">الإجمالى</th>
              </tr>
            </thead>
            <tbody>
              <t t-foreach="doc.order_line" t-as="l">
                <tr t-if="l.product_uom_qty">
                  <td><span t-field="l.name"/></td>
                  <td class="text-center">
                    <span t-field="l.product_uom_qty"/>
                    <span groups="product.group_uom" t-field="l.product_uom"/>
                  </td>
                  <td class="text-center"><span t-field="l.price_unit"/></td>
                  <td t-if="display_discount" class="text-center" groups="sale.group_discount_per_so_line"><span t-field="l.discount"/></td>
                  <td class="text-center"><span t-esc="', '.join([(t.description or t.name) for t in l.tax_id])"/></td>
                  <td class="text-center"><span t-field="l.price_subtotal"/></td>
                </tr>
              </t>
            </tbody>
          </table>

          <br/>

          <!-- الإجماليات -->
          <div name="total" class="float-start" style="direction: rtl; text-align: right; width: 350px;">
            <table class="table table-condensed table-borderless">
              <tr class="border-black">
                <td><strong>الإجمالى قبل الضريبة</strong></td>
                <td class="text-center"><span t-field="doc.amount_untaxed"/></td>
              </tr>
              <tr>
                <td>الضريبة</td>
                <td class="text-center"><span t-field="doc.amount_tax"/></td>
              </tr>
              <tr class="border-black">
                <td><strong>الإجمالى بعد الضريبة</strong></td>
                <td class="text-center"><span t-field="doc.amount_total"/></td>
              </tr>
            </table>
          </div>

          <!-- الملاحظات -->
          <div style="direction: rtl; text-align: right;">
            <p t-if="doc.note">
              <strong>ملاحظات: </strong>
              <span t-field="doc.note"/>
            </p>
            <p t-if="doc.payment_term_id">
              <strong>شروط الدفع: </strong>
              <span t-field="doc.payment_term_id"/>
            </p>
          </div>

          <div class="oe_structure"/>
        </div>
      </t>
    </template>
  </data>
</odoo>
